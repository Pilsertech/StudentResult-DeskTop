<!DOCTYPE html>
<div class="left-sidebar" id="leftSidebar">
    <div class="sidebar-content">
        <!-- User Profile Section -->
        <div class="user-info">
            <div class="user-avatar">
                <div class="avatar-fallback">
                    <i class="fa fa-user-shield"></i>
                </div>
            </div>
            <div class="user-details">
                <h6 class="user-name">Administrator</h6>
                <small class="user-role">System Admin</small>
                <div class="session-info">
                    <i class="fa fa-clock-o"></i>
                    <span id="sessionDuration">00:00:00</span>
                </div>
            </div>
        </div>

        <!-- Navigation Menu -->
        <div class="sidebar-nav">
            <ul class="side-nav">
                <!-- Dashboard -->
                <li class="nav-header">
                    <span>OVERVIEW</span>
                </li>
                <li class="nav-item" data-page="dashboard">
                    <a href="../dashboard/dashboard.html">
                        <i class="fa fa-tachometer"></i>
                        <span class="nav-text">Dashboard</span>
                    </a>
                </li>

                <!-- Academic Management -->
                <li class="nav-header">
                    <span>ACADEMIC</span>
                </li>
                
                <li class="nav-item has-submenu" data-menu="classes">
                    <a href="javascript:void(0)" onclick="toggleSubmenu('classes')">
                        <i class="fa fa-university"></i>
                        <span class="nav-text">Classes</span>
                        <i class="fa fa-chevron-right arrow"></i>
                    </a>
                </li>
                
                <li class="nav-item has-submenu" data-menu="subjects">
                    <a href="javascript:void(0)" onclick="toggleSubmenu('subjects')">
                        <i class="fa fa-book"></i>
                        <span class="nav-text">Subjects</span>
                        <i class="fa fa-chevron-right arrow"></i>
                    </a>
                </li>

                <!-- Student Management -->
                <li class="nav-header">
                    <span>STUDENTS</span>
                </li>
                
                <li class="nav-item has-submenu" data-menu="students">
                    <a href="javascript:void(0)" onclick="toggleSubmenu('students')">
                        <i class="fa fa-graduation-cap"></i>
                        <span class="nav-text">Students</span>
                        <i class="fa fa-chevron-right arrow"></i>
                    </a>
                </li>

                <!-- NEW: Attendance Management -->
                <li class="nav-item has-submenu" data-menu="attendance">
                    <a href="javascript:void(0)" onclick="toggleSubmenu('attendance')">
                        <i class="fa fa-calendar-check-o"></i>
                        <span class="nav-text">Attendance</span>
                        <i class="fa fa-chevron-right arrow"></i>
                    </a>
                </li>

                <!-- NEW: ID Cards -->
                <li class="nav-item has-submenu" data-menu="idcards">
                    <a href="javascript:void(0)" onclick="toggleSubmenu('idcards')">
                        <i class="fa fa-id-card"></i>
                        <span class="nav-text">ID Cards</span>
                        <i class="fa fa-chevron-right arrow"></i>
                    </a>
                </li>

                <!-- Results -->
                <li class="nav-header">
                    <span>RESULTS</span>
                </li>
                
                <li class="nav-item has-submenu" data-menu="results">
                    <a href="javascript:void(0)" onclick="toggleSubmenu('results')">
                        <i class="fa fa-bar-chart"></i>
                        <span class="nav-text">Results</span>
                        <i class="fa fa-chevron-right arrow"></i>
                    </a>
                </li>

                <li class="nav-item" data-page="find-result">
                    <a href="../login/find-result.html">
                        <i class="fa fa-search"></i>
                        <span class="nav-text">Find Result</span>
                    </a>
                </li>

                <!-- System -->
                <li class="nav-header">
                    <span>SYSTEM</span>
                </li>
                
                <li class="nav-item has-submenu" data-menu="settings">
                    <a href="javascript:void(0)" onclick="toggleSubmenu('settings')">
                        <i class="fa fa-cogs"></i>
                        <span class="nav-text">Settings</span>
                        <i class="fa fa-chevron-right arrow"></i>
                    </a>
                </li>

                <li class="nav-item" data-page="change-password">
                    <a href="../account/change-password.html">
                        <i class="fa fa-key"></i>
                        <span class="nav-text">Change Password</span>
                    </a>
                </li>

                <li class="nav-item logout-item">
                    <a href="../login/index.html" onclick="return confirmLogout()">
                        <i class="fa fa-sign-out"></i>
                        <span class="nav-text">Logout</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Footer -->
        <div class="sidebar-footer">
            <div class="footer-content">
                <small><i class="fa fa-graduation-cap"></i> SRMS v1.0.0</small>
                <small><i class="fa fa-calendar"></i> <span id="footerDate"></span></small>
            </div>
        </div>
    </div>
</div>

<!-- Floating Submenus -->
<div class="submenu-container" id="submenuContainer">
    <!-- Classes Submenu -->
    <div class="submenu" id="submenu-classes">
        <div class="submenu-header">
            <h4>Class Management</h4>
            <button class="close-btn" onclick="closeSubmenu()">&times;</button>
        </div>
        <div class="submenu-content">
            <a href="../classes/create-class.html" data-page="create-class">
                <i class="fa fa-plus-circle"></i>
                <span>Add New Class</span>
            </a>
            <a href="../classes/manage-classes.html" data-page="manage-classes">
                <i class="fa fa-list-alt"></i>
                <span>Manage Classes</span>
            </a>
        </div>
    </div>

    <!-- Subjects Submenu -->
    <div class="submenu" id="submenu-subjects">
        <div class="submenu-header">
            <h4>Subject Management</h4>
            <button class="close-btn" onclick="closeSubmenu()">&times;</button>
        </div>
        <div class="submenu-content">
            <a href="../subjects/create-subject.html" data-page="create-subject">
                <i class="fa fa-plus"></i>
                <span>Add Subject</span>
            </a>
            <a href="../subjects/manage-subjects.html" data-page="manage-subjects">
                <i class="fa fa-edit"></i>
                <span>Manage Subjects</span>
            </a>
            <a href="../subjects/add-subjectcombination.html" data-page="add-subjectcombination">
                <i class="fa fa-link"></i>
                <span>Add Combinations</span>
            </a>
            <a href="../subjects/manage-subjectcombination.html" data-page="manage-subjectcombination">
                <i class="fa fa-cogs"></i>
                <span>Manage Combinations</span>
            </a>
        </div>
    </div>

    <!-- Students Submenu -->
    <div class="submenu" id="submenu-students">
        <div class="submenu-header">
            <h4>Student Records</h4>
            <button class="close-btn" onclick="closeSubmenu()">&times;</button>
        </div>
        <div class="submenu-content">
            <a href="../students/add-students.html" data-page="add-students">
                <i class="fa fa-user-plus"></i>
                <span>Add Student</span>
            </a>
            <a href="../students/manage-students.html" data-page="manage-students">
                <i class="fa fa-users"></i>
                <span>Manage Students</span>
            </a>
        </div>
    </div>

    <!-- NEW: Attendance Submenu -->
    <div class="submenu" id="submenu-attendance">
        <div class="submenu-header">
            <h4>Attendance Management</h4>
            <button class="close-btn" onclick="closeSubmenu()">&times;</button>
        </div>
        <div class="submenu-content">
            <a href="../attendance/take-attendance.html" data-page="take-attendance">
                <i class="fa fa-user-check"></i>
                <span>Take Attendance</span>
            </a>
            <a href="../attendance/qr-attendance.html" data-page="qr-attendance">
                <i class="fa fa-qrcode"></i>
                <span>QR Code Attendance</span>
            </a>
            <a href="../attendance/manage-attendance.html" data-page="manage-attendance">
                <i class="fa fa-calendar"></i>
                <span>Manage Attendance</span>
            </a>
            <a href="../attendance/attendance-reports.html" data-page="attendance-reports">
                <i class="fa fa-chart-bar"></i>
                <span>Attendance Reports</span>
            </a>
            <a href="../attendance/attendance-settings.html" data-page="attendance-settings">
                <i class="fa fa-cogs"></i>
                <span>Attendance Settings</span>
            </a>
        </div>
    </div>

    <!-- NEW: ID Cards Submenu -->
    <div class="submenu" id="submenu-idcards">
        <div class="submenu-header">
            <h4>ID Card Management</h4>
            <button class="close-btn" onclick="closeSubmenu()">&times;</button>
        </div>
        <div class="submenu-content">
            <a href="../idcards/generate-cards.html" data-page="generate-cards">
                <i class="fa fa-id-card-o"></i>
                <span>Generate ID Cards</span>
            </a>
            <a href="../idcards/card-templates.html" data-page="card-templates">
                <i class="fa fa-paint-brush"></i>
                <span>Card Templates</span>
            </a>
            <a href="../idcards/print-cards.html" data-page="print-cards">
                <i class="fa fa-print"></i>
                <span>Print ID Cards</span>
            </a>
        </div>
    </div>

    <!-- Results Submenu -->
    <div class="submenu" id="submenu-results">
        <div class="submenu-header">
            <h4>Result Management</h4>
            <button class="close-btn" onclick="closeSubmenu()">&times;</button>
        </div>
        <div class="submenu-content">
            <a href="../results/add-result.html" data-page="add-result">
                <i class="fa fa-plus-circle"></i>
                <span>Add Result</span>
            </a>
            <a href="../results/manage-results.html" data-page="manage-results">
                <i class="fa fa-table"></i>
                <span>Manage Results</span>
            </a>
            <a href="../results/result.html" data-page="result">
                <i class="fa fa-search"></i>
                <span>View Results</span>
            </a>
        </div>
    </div>

    <!-- Settings Submenu -->
    <div class="submenu" id="submenu-settings">
        <div class="submenu-header">
            <h4>System Settings</h4>
            <button class="close-btn" onclick="closeSubmenu()">&times;</button>
        </div>
        <div class="submenu-content">
            <a href="javascript:void(0)" onclick="openDatabaseBackup()">
                <i class="fa fa-database"></i>
                <span>Database Backup</span>
            </a>
            <a href="javascript:void(0)" onclick="openDatabaseRestore()">
                <i class="fa fa-upload"></i>
                <span>Database Restore</span>
            </a>
            <a href="javascript:void(0)" onclick="openSystemSettings()">
                <i class="fa fa-wrench"></i>
                <span>System Settings</span>
            </a>
        </div>
    </div>
</div>

<!-- Toggle Button -->
<div class="sidebar-toggle" onclick="toggleSidebar()">
    <i class="fa fa-bars" id="toggleIcon"></i>
</div>

<script>
// JavaScript code for sidebar functionality
(function() {
    'use strict';
    
    let sessionStartTime = new Date();
    
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initializeLeftbar, 100);
        setupScrollIsolation();
    });
    
    function initializeLeftbar() {
        setActiveMenuItem();
        updateFooterDate();
        updateSessionDuration();
        addTooltips();
        handleAvatarLoad();
        
        setInterval(updateSessionDuration, 1000);
        setInterval(updateFooterDate, 60000);
        
        console.log('✅ Fixed leftbar initialized');
    }
    
    // FIXED: Prevent scroll propagation to dashboard
    function setupScrollIsolation() {
        const sidebarNav = document.querySelector('.sidebar-nav');
        const childNavs = document.querySelectorAll('.child-nav');
        
        // Isolate main sidebar scroll
        if (sidebarNav) {
            sidebarNav.addEventListener('wheel', function(e) {
                const isScrollable = sidebarNav.scrollHeight > sidebarNav.clientHeight;
                if (isScrollable) {
                    e.stopPropagation();
                }
            });
        }
        
        // Isolate submenu scroll
        childNavs.forEach(nav => {
            nav.addEventListener('wheel', function(e) {
                const isScrollable = nav.scrollHeight > nav.clientHeight;
                if (isScrollable) {
                    e.stopPropagation();
                }
            });
        });
        
        console.log('🔒 Scroll isolation setup complete');
    }
    
    function handleAvatarLoad() {
        const img = document.querySelector('.profile-img');
        const fallback = document.querySelector('.avatar-fallback');
        
        if (img && fallback) {
            img.addEventListener('error', function() {
                img.style.display = 'none';
                fallback.style.display = 'flex';
            });
            
            img.addEventListener('load', function() {
                fallback.style.display = 'none';
                img.style.display = 'block';
            });
        }
    }
    
    function updateSessionDuration() {
        const now = new Date();
        const duration = now - sessionStartTime;
        
        const hours = Math.floor(duration / (1000 * 60 * 60));
        const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((duration % (1000 * 60)) / 1000);
        
        const durationString = 
            String(hours).padStart(2, '0') + ':' + 
            String(minutes).padStart(2, '0') + ':' + 
            String(seconds).padStart(2, '0');
        
        const durationElement = document.getElementById('sessionDuration');
        if (durationElement) {
            durationElement.textContent = durationString;
        }
    }
    
    function updateFooterDate() {
        const now = new Date();
        const dateString = now.getFullYear() + '-' + 
                          String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                          String(now.getDate()).padStart(2, '0');
        
        const footerElement = document.getElementById('footerDate');
        if (footerElement) {
            footerElement.textContent = dateString;
        }
    }
    
    function setActiveMenuItem() {
        const currentPath = window.location.pathname;
        const currentPage = currentPath.split('/').pop().replace('.html', '');
        
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelectorAll('.child-nav a').forEach(link => {
            link.classList.remove('active');
        });
        
        document.querySelectorAll('.nav-item a, .child-nav a').forEach(link => {
            const href = link.getAttribute('href');
            
            if (href && href !== '#') {
                const linkPage = href.split('/').pop().replace('.html', '');
                
                if (linkPage === currentPage || 
                    (currentPage === 'dashboard' && href.includes('dashboard'))) {
                    
                    link.classList.add('active');
                    const parentItem = link.closest('.nav-item');
                    if (parentItem) {
                        parentItem.classList.add('active');
                        
                        const hasChildren = link.closest('.has-children');
                        if (hasChildren && hasChildren !== parentItem) {
                            const sidebar = document.getElementById('leftSidebar');
                            sidebar.classList.add('expanded');
                            
                            setTimeout(() => {
                                hasChildren.classList.add('open');
                            }, 100);
                        }
                    }
                }
            }
        });
    }
    
    function addTooltips() {
        document.querySelectorAll('.nav-item').forEach(item => {
            const link = item.querySelector('a');
            const textSpan = link?.querySelector('.nav-text');
            if (textSpan && textSpan.textContent) {
                item.setAttribute('data-tooltip', textSpan.textContent.trim());
            }
        });
    }

    console.log('✅ Leftbar script loaded');
})();

// FIXED: Global Functions with Proper Scope
function toggleSidebar() {
    const sidebar = document.getElementById('leftSidebar');
    const icon = document.getElementById('toggleIcon');
    
    if (sidebar) {
        sidebar.classList.toggle('expanded');
        
        if (sidebar.classList.contains('expanded')) {
            icon.className = 'fa fa-indent';
            console.log('📖 Sidebar expanded');
        } else {
            icon.className = 'fa fa-bars';
            console.log('📕 Sidebar collapsed');
            
            // Close all submenus when collapsing
            document.querySelectorAll('.has-children.open').forEach(menu => {
                menu.classList.remove('open');
            });
        }
    }
}

function toggleMenu(element, menuTitle) {
    const sidebar = document.getElementById('leftSidebar');
    
    // Expand sidebar if collapsed
    if (!sidebar.classList.contains('expanded')) {
        sidebar.classList.add('expanded');
        const icon = document.getElementById('toggleIcon');
        if (icon) icon.className = 'fa fa-indent';
        
        setTimeout(() => toggleMenuHelper(element, menuTitle), 300);
        return;
    }
    
    toggleMenuHelper(element, menuTitle);
}

function toggleMenuHelper(element, menuTitle) {
    const parentLi = element.closest('.has-children');
    
    if (!parentLi) return;
    
    // Close other menus
    document.querySelectorAll('.has-children.open').forEach(menu => {
        if (menu !== parentLi) {
            menu.classList.remove('open');
        }
    });
    
    // Toggle current menu with delay for stability
    const isOpen = parentLi.classList.contains('open');
    
    if (isOpen) {
        parentLi.classList.remove('open');
        console.log('📁 Panel closed:', menuTitle);
    } else {
        // Small delay to ensure stable display
        setTimeout(() => {
            parentLi.classList.add('open');
            console.log('📂 Panel opened:', menuTitle);
        }, 50);
    }
}

// FIXED: Working Close Submenu Function - Global Scope
function closeSubmenu(closeBtn) {
    const parentMenu = closeBtn.closest('.has-children');
    if (parentMenu) {
        parentMenu.classList.remove('open');
        console.log('🚪 Submenu closed via close button');
    }
}

function confirmLogout() {
    const sessionDuration = document.getElementById('sessionDuration');
    const duration = sessionDuration ? sessionDuration.textContent : '00:00:00';
    
    if (confirm(`Are you sure you want to logout?\n\nSession Duration: ${duration}\nUser: Pilsertech\nSystem: SRMS Dashboard`)) {
        localStorage.clear();
        sessionStorage.clear();
        return true;
    }
    return false;
}

console.log('✅ All leftbar functions loaded globally');
</script>